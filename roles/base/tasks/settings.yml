---
- name: Copy /etc/ssh/sshd_config
  copy:
    src: sshd_config
    dest: /etc/ssh/sshd_config
    owner: root
    mode: 0644
  notify:
    - restart sshd

- name: Copy /etc/sysctl.conf
  copy:
    src: sysctl.conf
    dest: /etc/sysctl.conf
    owner: root
    mode: 0644
  notify:
    - reload sysctl

- name: Blacklist SPECK module
  copy:
    content: "blacklist CONFIG_CRYPTO_SPECK"
    dest: /etc/modprobe.d/blacklist.conf
  become: yes
  when: ansible_distribution == 'Debian'

- name: Modify /etc/issue
  copy:
    dest: "{{ item }}"
    content: 'Access to this computer is prohibited.'
  with_items:
    - /etc/issue
    - /etc/issue.net

- name: Check if there is NetworkManager conf.d
  stat:
    path: /etc/NetworkManager/conf.d
  register: check_network_manager

- name: Ensure NetworkManager won't override resolv.conf
  copy:
    dest: /etc/NetworkManager/conf.d/no-dns.conf
    content: "[main]\ndns=none\n"
  when: check_network_manager.stat.exists and check_network_manager.stat.isdir

- name: Copy Knot settings
  copy:
    src: kresd.conf
    dest: /etc/knot-resolver/kresd.conf
    owner: root
    mode: 0644

- name: enable Knot resolver
  shell: systemctl enable --now kresd@1.service

- name: Restart Knot-resolver
  systemd:
    state: restarted
    daemon_reload: yes
    name: kresd@1

- name: Switch to the local resolver
  copy:
    dest: /etc/resolv.conf
    content: '127.0.0.1'

- name: Make /etc/resolv.conf immutable
  file:
    path: /etc/resolv.conf
    attr: +i
