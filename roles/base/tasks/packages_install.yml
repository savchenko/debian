---
- name: Install list of packages
  apt:
    name: "{{ pkg }}"
  vars:
    pkg:
      - apt-transport-https
      - apt-listbugs
      - debian-goodies
      - bash-completion
      - ca-certificates
      - curl
      - dfc
      - dnsutils
      - fzf
      - git
      - gnupg2
      - grc
      - htop
      - ioping
      - keychain
      - knot-resolver
      - libpam-tmpdir
      - lshw
      - lsof
      - lua5.3
      - man-db
      - mc
      - ncdu
      - ncurses-base
      - ncurses-term
      - needrestart
      - neovim
      - neovim-runtime
      - python
      - python-pip
      - python3
      - python3-pip
      - rsync
      - ruby
      - silversearcher-ag
      - sshguard
      - strace
      - sudo
      - sysstat
      - tmux
      - tree
      - unattended-upgrades
      - wget

- name: Install Intel CPU firmware if necessary
  apt:
    name: intel-microcode
  when: '"Intel" in cpu_vendor and not WSL2'

- name: Ensure ~/.gnupg is initialized
  shell: gpg -k

- name: Set lua5.3 as default `lua` command
  shell: "{{ item }}"
  with_items:
    - update-alternatives --install /etc/alternatives/lua-interpretor lua /usr/bin/lua5.3 1
    - update-alternatives --install /usr/bin/lua lua-interpreter /usr/bin/lua5.3 130 --slave /usr/share/man/man1/lua.1.gz lua-manual /usr/share/man/man1/lua5.3.1.gz
    - update-alternatives --install /usr/bin/luac lua-compiler /usr/bin/luac5.3 130 --slave /usr/share/man/man1/luac.1.gz lua-compiler-manual /usr/share/man/man1/luac5.3.1.gz
  become: yes

- name: Unarchive z.lua into `/usr/local/bin` and make it executable
  unarchive:
    src: z.lua.tgz
    dest: /usr/local/bin
    mode: a+x

- name: Create Perl modules folder
  file:
    path: "/usr/local/lib/site_perl/"
    state: directory

- name: Copy diff-so-fancy and its dependencies
  copy:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    mode: "{{ item.mode }}"
  with_items:
    - { src: 'diff-so-fancy.pl', dest: '/usr/local/bin/diff-so-fancy', mode: 'a+x'}
    - { src: 'DiffHighlight.pm', dest: '/usr/local/lib/site_perl/DiffHighlight.pm', mode: '0644'}

- name: Check if .DEBs are installed
  command: "dpkg-query -W {{ item }}"
  register: dpkg_check
  failed_when: dpkg_check.rc > 1
  changed_when: dpkg_check.rc == 1
  loop:
    - hstr
    - bat

- name: Create directory to store .deb files
  file:
    path: /tmp/st_deb
    state: directory
  when: dpkg_check is changed

- name: Copy .deb packages to the remote host
  copy:
    src: "{{ item }}"
    dest: "/tmp/st_deb/{{ item }}"
  loop: "{{ debs }}"
  register: debs_copy_status
  when: dpkg_check is changed

- name: Install .deb packages that are currently not in Debian repos
  apt:
    allow_unauthenticated: yes
    deb: "{{ item['dest'] }}"
  loop: "{{ debs_copy_status.results }}"
  when: ansible_architecture == "x86_64" and dpkg_check is changed

- name: Delete /tmp/st_deb
  file:
    path: /tmp/st_deb
    state: absent
